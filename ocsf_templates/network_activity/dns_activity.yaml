# OCSF Gold Mapping Template: dns_activity
# Class UID: 4003 | Category: Network Activity
#
# DNS query and response events.
# Fields are ordered to match the OCSF schema - DO NOT reorder!

gold:
  # Note: clusterBy is supported in SSS (Spark Structured Streaming) mode but not in SDP mode (sinks don't support it atm)
  # For SDP mode, run ALTER TABLE after pipeline creation:
  #   ALTER TABLE <catalog>.<database>.dns_activity CLUSTER BY (time, query.hostname)
  - name: dns_activity
    input: <YOUR_SILVER_TABLE_NAME>
    # filter: |
    #   query_name IS NOT NULL
    # clusterBy: ["time", "query.hostname"]  # Only works in SSS mode (src/sss_gold.py)
    fields:
      # Core fields
      - name: activity_id
        expr: # 1=Query, 2=Response, 6=Traffic
      - name: activity_name
        expr: # 'Query', 'Response', 'Traffic'
      
      # Answers (for DNS responses)
      - name: answers
        expr: # Array of DNS answer records
      
      # App name (optional)
      # - name: app_name
      #   expr: # Application name
      
      # Category & Class
      - name: category_name
        literal: Network Activity
      - name: category_uid
        expr: CAST(4 AS INT)
      - name: class_name
        literal: DNS Activity
      - name: class_uid
        expr: CAST(4003 AS INT)
      
      - name: connection_info.protocol_name
        expr: # 'udp', 'tcp', 'doh', 'dot'
      - name: connection_info.protocol_num
        expr: # 17=UDP, 6=TCP
      - name: connection_info.direction
        literal: Unknown
      - name: connection_info.direction_id
        expr: CAST(0 AS INT)
      # - name: connection_info.uid
      #   expr: # Connection/query ID
      
      # Disposition
      # - name: disposition
      #   expr: # 'Allowed', 'Blocked', 'Sinkholed'
      # - name: disposition_id
      #   expr: # 1=Allowed, 2=Blocked
      
      # Destination endpoint (DNS server)
      - name: dst_endpoint.ip
        expr: # DNS server IP
      # - name: dst_endpoint.port
      #   expr: # Usually 53
      
      - name: action
        expr: # TODO: Map to your source field

      - name: action_id
        expr: # TODO: Map to your source field

      - name: activity
        expr: # TODO: Map to your source field

      - name: app_name
        expr: # TODO: Map to your source field

      - name: disposition
        expr: # TODO: Map to your source field

      - name: disposition_id
        expr: # TODO: Map to your source field

      - name: enrichments
        expr: # TODO: Map to your source field (VARIANT/ARRAY)

      - name: message
        expr: # TODO: Map to your source field

      - name: observables
        expr: # TODO: Map to your source field (VARIANT/ARRAY)

      - name: policy
        expr: # TODO: Map to your source field

      - name: status
        expr: # TODO: Map to your source field

      - name: status_code
        expr: # TODO: Map to your source field

      - name: status_detail
        expr: # TODO: Map to your source field

      - name: status_id
        expr: # TODO: Map to your source field

      - name: traffic
        expr: # TODO: Map to your source field
      # Metadata (OCSF Standard Fields)
      - name: metadata.version
        literal: "1.7.0"  # OCSF schema version
      - name: metadata.product.name
        literal: # Product name (e.g., "Zeek Conn", "Cisco IOS")
      - name: metadata.product.vendor_name
        literal: # Vendor name (e.g., "Zeek", "Cisco")
      - name: metadata.log_provider
        literal: # Log provider/source (e.g., "zeek", "cisco", "cloudflare")
      - name: metadata.log_name
        literal: # Log name/sourcetype (e.g., "conn", "ios", "gateway_dns")
      - name: metadata.log_format
        literal: # Log format (e.g., "JSON", "syslog", "CSV")
      - name: metadata.log_version
        literal: # Schema version format: "source@sourcetype:version@1.0" (e.g., "zeek@conn:version@1.0")
      - name: metadata.processed_time
        expr: CURRENT_TIMESTAMP()  # When processed by pipeline
      - name: metadata.logged_time
        from: time  # When the event was logged (REQUIRED: map to your time field)
      
      # Query details
      - name: query.hostname
        from: # FQDN being queried
      - name: query.type
        from: # 'A', 'AAAA', 'CNAME', 'MX', 'TXT'
      - name: query.class
        literal: IN
      # - name: query.packet_uid
      #   expr: # CAST(NULL AS INT) - usually not available
      - name: query.opcode
        literal: Query
      - name: query.opcode_id
        expr: CAST(0 AS INT)
      
      # Response code
      - name: rcode
        expr: # 'NoError', 'NXDomain', 'ServFail'
      - name: rcode_id
        from: # 0=NoError, 3=NXDomain, 2=ServFail
      
      # Raw data
      - name: raw_data
        expr: # CAST(to_json(...) AS VARIANT)
      
      # Severity
      - name: severity
        literal: Informational
      - name: severity_id
        expr: CAST(1 AS INT)
      
      # Source endpoint (client)
      - name: src_endpoint.ip
        from: # Client IP
      # - name: src_endpoint.port
      #   from: # Source port
      
      # Status
      # - name: status
      #   expr: # 'Success', 'Failure'
      # - name: status_code
      #   expr: # Response code as string
      # - name: status_detail
      #   expr: # Details
      # - name: status_id
      #   from: # rcode_id
      
      # Time
      - name: time
        from: # Query/response timestamp (REQUIRED)
      - name: timezone_offset
        expr: # CAST(NULL AS INT)
      
      # Traffic (optional)
      # - name: traffic.bytes_in
      #   expr: # Query size in bytes
      
      # Type
      - name: type_name
        expr: # CONCAT('DNS Activity: ', activity_name, ' [', query_type, ']')
      - name: type_uid
        expr: # CAST(class_uid * 100 + activity_id AS BIGINT)
      
      # Action/Disposition (optional, for security-focused DNS)
      # - name: action
      #   expr: # 'Allowed', 'Denied'
      # - name: action_id
      #   expr: # 1=Allowed, 2=Denied
      
      # Unmapped
      - name: unmapped
        expr: # CAST(to_json(...) AS VARIANT)
